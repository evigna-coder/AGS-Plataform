# AGS Plataform â€” Plan Maestro de Arquitectura (v1.0)
> **Fecha:** Febrero 2026 | **Autor:** Arq. de Software / Tech Lead  
> **Source of truth:** [DOCUMENTACION_TECNICA_AGS.md](file:///c:/Users/Evigna/Desktop/Ags%20plataform/docs/DOCUMENTACION_TECNICA_AGS.md), [DOCUMENTACION_NEGOCIO_AGS.md](file:///c:/Users/Evigna/Desktop/Ags%20plataform/docs/DOCUMENTACION_NEGOCIO_AGS.md), [packages/shared/src/types/index.ts](file:///c:/Users/Evigna/Desktop/Ags%20plataform/packages/shared/src/types/index.ts)

---

## 0. Resumen Ejecutivo

El sistema tiene **dos frentes activos** y un **paquete compartido de tipos**:

| App | Stack | Estado | PrÃ³ximo hito |
|-----|-------|--------|--------------|
| `apps/sistema-modular` | React 19 + Tailwind + Electron | Activo / en expansiÃ³n | Import masivo Excel â†’ Firestore |
| `apps/reportes-ot` | React 19 + html2pdf.js | Funcional (legacy) | Motor de Protocolos/Tablas dinÃ¡micas |
| `packages/shared` | TypeScript Types | Activo | Nuevos tipos: `ProtocolTable`, `RenderSpec`, `Adjunto` |

**Principios de diseÃ±o no negociables (resumen):**
- **SKILL A:** Layout de `reportes-ot` es sagrado. NingÃºn cambio visual en Hoja 1.
- **SKILL B:** Nunca campos `undefined` al escribir en Firestore.
- **SKILL C:** No archivos >250 lÃ­neas sin hooks en `sistema-modular`.
- **No almacenar PDFs**; regenerar on-demand desde `RenderSpec` + datos planos.

---

## 1. Arquitectura Propuesta

### 1.1 Diagrama de MÃ³dulos y LÃ­mites

```mermaid
graph TD
    subgraph "apps/sistema-modular (Back-Office)"
        SM_Clientes["ğŸ“‹ MÃ³dulo Clientes\n(CRUD + baja lÃ³gica)"]
        SM_Establ["ğŸ¢ MÃ³dulo Establecimientos\n+ Contactos"]
        SM_Sistemas["âš™ï¸ MÃ³dulo Sistemas\n+ MÃ³dulos (subcolecciÃ³n)"]
        SM_Import["ğŸ“¥ Import Masivo\n(UI de carga Excel)"]
        SM_ProtoCatalog["ğŸ—‚ï¸ CatÃ¡logo de Protocolos\n(Admin de tablas maestras)"]
        SM_OTs["ğŸ“„ Vista OTs\n(solo lectura / estados)"]
    end

    subgraph "apps/reportes-ot (Tablet Field App)"
        ROT_OTForm["ğŸ“ Formulario OT\n(mixto: DB-selector + override)"]
        ROT_Hoja1["ğŸ–¨ï¸ Hoja 1 PDF\n(â›” INTOCABLE)"]
        ROT_Hoja2["ğŸ“Š Hoja 2 â€” Selector\nde Tablas de Protocolo"]
        ROT_PDFGen["âš¡ Motor PDF\nhtml2pdf.js + RenderSpec"]
        ROT_Adjuntos["ğŸ“ Adjuntos / Fotos"]
    end

    subgraph "packages/shared"
        SH_Types["ğŸ“¦ @ags/shared\nTypes TS (source of truth)"]
    end

    subgraph "Firebase"
        FS["ğŸ”¥ Firestore\n(colecciones + subcolecciones)"]
        FSTOR["ğŸ—„ï¸ Firebase Storage\n(fotos / adjuntos)"]
        AUTH["ğŸ” Firebase Auth"]
    end

    subgraph "scripts/migracion"
        SCRIPT["ğŸ› ï¸ migrar-desde-excel.ts\n(Node + Admin SDK\n--dry-run / --run)"]
    end

    SM_Import --> SCRIPT
    SCRIPT --> FS
    SM_Clientes & SM_Establ & SM_Sistemas & SM_ProtoCatalog --> FS
    ROT_OTForm -->|"Lee catÃ¡logos (clientes/sistemas/mÃ³dulos/tablas)"| FS
    ROT_OTForm -->|"Guarda WorkOrder + RenderSpec"| FS
    ROT_PDFGen -->|"Regenera PDF on-demand"| ROT_Hoja1
    ROT_PDFGen --> ROT_Hoja2
    ROT_Adjuntos --> FSTOR
    SM_Types & SH_Types -->|"Importados como @ags/shared"| SM_Clientes
    SH_Types -->|"Importados como @ags/shared"| ROT_OTForm
    AUTH -->|"Roles: admin / tecnico / readonly"| SM_Clientes
    AUTH --> ROT_OTForm
```

### 1.2 Data-Flow: CreaciÃ³n de una OT completa

```
[TÃ©cnico en tablet]
    â”‚
    â–¼
ROT_OTForm (mixto)
    â”œâ”€â€ Selector Cliente  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FS: /clientes/{cuit}
    â”œâ”€â Selector Establecimiento  â”€â”€â”€â”€â”€â”€â”€â”€ FS: /establecimientos/{id}
    â”œâ”€â‚ Selector Sistema / MÃ³dulo  â”€â”€â”€â”€â”€â”€â”€â”€ FS: /sistemas/{id} + /sistemas/{id}/modulos
    â”œâ”€âƒ Selector TipoServicio  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FS: /tiposServicio/{id}
    â”œâ”€â„ Selector Protocolo (si aplica)  â”€â”€ FS: /protocolCatalog/{sysType}/tables[]
    â”‚   â”œâ”€â”€ valida sysType + modelo
    â”‚   â”œâ”€â”€ muestra tablas compatibles + defaults del sistema
    â”‚   â””â”€â”€ permite fallback manual
    â”œâ”€â… Inputs libres (horas, repuestos, tÃ©cnico, observaciones)
    â”œâ”€â† Firma TÃ©cnico + Firma Cliente (canvas)
    â””â”€â‡ SAVE â†’ WorkOrder + RenderSpec â†’ FS /workorders/{otNumber}

[On-demand PDF]
    WorkOrder + RenderSpec  â”€â”€â”€â”€â”€â–º html2pdf.js â”€â”€â–º PDF
                                        â”œâ”€â”€ Hoja 1 (invariante)
                                        â””â”€â”€ Hoja 2 (tablas dinÃ¡micas)

[On-demand con adjuntos]
    RenderSpec.adjuntos[]  â”€â”€â”€â”€â”€â–º Firebase Storage (signed URLs)
                                        â”œâ”€â”€ Hoja 3: Anexo fotogrÃ¡fico
                                        â””â”€â”€ Hoja 4: Archivos adjuntos
```

---

## 2. Modelo de Datos (Firestore)

### 2.1 Colecciones y jerarquÃ­a

```
/clientes/{cuit}                          â† ya existe
/establecimientos/{id}                    â† ya existe
  â””â”€ /contactos/{id}                      â† ya existe
/sistemas/{id}                            â† ya existe
  â””â”€ /modulos/{id}                        â† ya existe (subcolecciÃ³n)
/tiposServicio/{id}                       â† ya existe
/workorders/{otNumber}                    â† ya existe (en reportes-ot)
/protocolCatalog/{catalogId}              â† ğŸ†• NUEVO
/renderSpecs/{otNumber}                   â† ğŸ†• NUEVO (o subcolecciÃ³n de workorders)
/adjuntos/{adjuntoId}                     â† ğŸ†• NUEVO (metadata; binario en Storage)
/usuarios/{uid}                           â† ğŸ†• NUEVO (roles + audit)
```

> **DecisiÃ³n de diseÃ±o:** `renderSpecs` puede vivir como subcolecciÃ³n de `workorders` (`/workorders/{otNumber}/renderSpec/current`) o como top-level. **Default propuesto:** subcolecciÃ³n para co-localizaciÃ³n y reglas de seguridad simplificadas.

---

### 2.2 Nuevos tipos en `@ags/shared`

```typescript
// â”€â”€â”€ CATÃLOGO DE PROTOCOLOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** ColecciÃ³n: /protocolCatalog/{catalogId} */
export interface ProtocolCatalogEntry {
  id: string;
  /** Tipo de sistema al que aplica: 'HPLC' | 'GC' | 'UV' | 'OSMOMETRO' | ... */
  sysType: string;
  /** Modelos compatibles (ej: ['1260', '1200', '1100']). null = todos los modelos del sysType */
  modelosCompatibles: string[] | null;
  name: string;          // Nombre legible del protocolo
  version: string;       // ej: "2.1"
  tables: ProtocolTable[];
  isDefault: boolean;    // Si es la tabla default sugerida para este sysType/modelo
  activo: boolean;
  createdAt: string;
  updatedAt: string;
  createdBy: string;
}

/** Tabla individual dentro de un protocolo */
export interface ProtocolTable {
  tableId: string;       // UUID estable (no cambia entre versiones)
  name: string;          // "VerificaciÃ³n de Flujo", "Test de Linealidad", etc.
  description?: string;
  columns: TableColumn[];
  /** Filas template con valores esperados/lÃ­mites (pre-cargados) */
  templateRows: TableRow[];
  /** Tipo de servicio al que aplica (puede ser multi) */
  tiposServicioIds: string[];
  orden: number;         // Orden de display dentro del protocolo
}

export interface TableColumn {
  key: string;
  label: string;
  type: 'text' | 'number' | 'pass_fail' | 'date';
  unit?: string;         // ej: "mL/min", "%", "nm"
  required: boolean;
  /** Valor esperado/lÃ­mite para mostrar en template */
  expectedValue?: string;
}

export interface TableRow {
  rowId: string;
  cells: Record<string, string | number | null>;
  isHeader?: boolean;
}

// â”€â”€â”€ RENDER SPEC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * EspecificaciÃ³n de renderizado: guarda TODO lo necesario para
 * regenerar el PDF de forma determinÃ­stica sin PDF binario.
 * ColecciÃ³n: /workorders/{otNumber}/renderSpec/current
 */
export interface RenderSpec {
  otNumber: string;
  /** VersiÃ³n del template de Hoja 1 (para detectar breaking changes futuros) */
  templateVersion: string;       // ej: "1.0"
  /** VersiÃ³n del normalizador de tablas */
  protocolVersion: string;       // ej: "2.1"
  /** VersiÃ³n del motor PDF (para saber quÃ© renderer usar) */
  rendererVersion: string;       // ej: "html2pdf-0.10"

  // â”€â”€ Snapshot completo de los datos capturados en el momento del guardado â”€â”€
  workOrderSnapshot: WorkOrder;  // Copia desnormalizada (protecciÃ³n ante renombres)

  // â”€â”€ Selecciones de protocolo â”€â”€
  protocolSelections: ProtocolSelection[] | null;

  // â”€â”€ Adjuntos vinculados â”€â”€
  adjuntosIds: string[];         // IDs en colecciÃ³n /adjuntos

  // Metadatos
  savedAt: string;               // ISO
  savedBy: string;               // uid
  updatedAt: string;
}

export interface ProtocolSelection {
  catalogId: string;            // FK a /protocolCatalog
  tableId: string;              // tableId dentro del catalogo
  /** Filas completadas por el tÃ©cnico en campo */
  completedRows: TableRow[];
  observaciones?: string;
  resultado: 'CONFORME' | 'NO_CONFORME' | 'PENDIENTE';
  completadoAt: string;
}

// â”€â”€â”€ ADJUNTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** ColecciÃ³n: /adjuntos/{adjuntoId} */
export interface Adjunto {
  id: string;
  otNumber: string;             // FK workorder
  tipo: 'foto' | 'archivo';
  storagePath: string;          // Ruta en Firebase Storage (ej: "adjuntos/30255/foto_001.jpg")
  /** URL firmada (se regenera al visualizar, NO se guarda) */
  fileName: string;
  mimeType: string;
  sizeBytes: number;
  caption?: string;
  orden: number;                // Para ordenar en el PDF
  uploadedAt: string;
  uploadedBy: string;           // uid
}

// â”€â”€â”€ USUARIO (roles) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export type RolUsuario = 'admin' | 'tecnico' | 'readonly';

export interface UsuarioAGS {
  uid: string;                  // Firebase Auth UID
  nombre: string;
  email: string;
  rol: RolUsuario;
  activo: boolean;
  createdAt: string;
  updatedAt: string;
}
```

---

### 2.3 Ejemplos de documentos Firestore

```json
// /protocolCatalog/hplc-linearity-v2
{
  "id": "hplc-linearity-v2",
  "sysType": "HPLC",
  "modelosCompatibles": ["1260", "1200", "1100"],
  "name": "OQ - Test de Linealidad (HPLC)",
  "version": "2.1",
  "isDefault": true,
  "activo": true,
  "tables": [
    {
      "tableId": "tbl-lin-001",
      "name": "VerificaciÃ³n de Linealidad del Detector",
      "orden": 1,
      "tiposServicioIds": ["calificacion-operacion"],
      "columns": [
        { "key": "concentracion", "label": "ConcentraciÃ³n", "type": "number", "unit": "ppm", "required": true },
        { "key": "absorbancia", "label": "Absorbancia", "type": "number", "unit": "AU", "required": true },
        { "key": "r2", "label": "RÂ²", "type": "number", "required": true, "expectedValue": ">= 0.999" },
        { "key": "resultado", "label": "Resultado", "type": "pass_fail", "required": true }
      ],
      "templateRows": [
        { "rowId": "r1", "cells": { "concentracion": 10, "absorbancia": null, "r2": null, "resultado": null } },
        { "rowId": "r2", "cells": { "concentracion": 25, "absorbancia": null, "r2": null, "resultado": null } },
        { "rowId": "r3", "cells": { "concentracion": 50, "absorbancia": null, "r2": null, "resultado": null } }
      ]
    }
  ],
  "createdAt": "2026-01-15T10:00:00Z",
  "updatedAt": "2026-02-01T09:00:00Z",
  "createdBy": "uid-admin-001"
}
```

```json
// /workorders/30255/renderSpec/current
{
  "otNumber": "30255",
  "templateVersion": "1.0",
  "protocolVersion": "2.1",
  "rendererVersion": "html2pdf-0.10",
  "workOrderSnapshot": {
    "otNumber": "30255",
    "razonSocial": "Laboratorio Pharma S.A.",
    "sistema": "HPLC Agilent 1260",
    "tipoServicio": "CalificaciÃ³n de OperaciÃ³n",
    "fechaInicio": "2026-02-25",
    "...": "todos los campos de WorkOrder"
  },
  "protocolSelections": [
    {
      "catalogId": "hplc-linearity-v2",
      "tableId": "tbl-lin-001",
      "completedRows": [
        { "rowId": "r1", "cells": { "concentracion": 10, "absorbancia": 0.102, "r2": 0.9998, "resultado": "PASS" } },
        { "rowId": "r2", "cells": { "concentracion": 25, "absorbancia": 0.251, "r2": 0.9998, "resultado": "PASS" } },
        { "rowId": "r3", "cells": { "concentracion": 50, "absorbancia": 0.499, "r2": 0.9998, "resultado": "PASS" } }
      ],
      "observaciones": "Detector UV a 254nm. Temperatura ambiente 22Â°C.",
      "resultado": "CONFORME",
      "completadoAt": "2026-02-25T14:30:00Z"
    }
  ],
  "adjuntosIds": ["adj-001", "adj-002"],
  "savedAt": "2026-02-25T15:00:00Z",
  "savedBy": "uid-tecnico-007",
  "updatedAt": "2026-02-25T15:00:00Z"
}
```

```json
// /adjuntos/adj-001
{
  "id": "adj-001",
  "otNumber": "30255",
  "tipo": "foto",
  "storagePath": "adjuntos/30255/foto_001.jpg",
  "fileName": "foto_001.jpg",
  "mimeType": "image/jpeg",
  "sizeBytes": 1245000,
  "caption": "Estado inicial del inyector automÃ¡tico",
  "orden": 1,
  "uploadedAt": "2026-02-25T14:15:00Z",
  "uploadedBy": "uid-tecnico-007"
}
```

---

## 3. Estrategia de Import Masivo desde Excel

### 3.1 Formato Excel esperado

Archivo: un `.xlsx` con **4 hojas** (o 4 archivos CSV separados):

| Hoja | Columnas obligatorias | Columnas opcionales |
|------|-----------------------|---------------------|
| `clientes` | `cuit`, `razonSocial`, `pais`, `rubro` | `direccionFiscal`, `localidad`, `condicionIva`, `notas` |
| `establecimientos` | `clienteCuit`, `nombre`, `direccion`, `localidad`, `provincia` | `codigoPostal`, `tipo`, `tipoServicio`, `lat`, `lng` |
| `sistemas` | `establecimientoRef` (nombre o id), `clienteCuit`, `categoriaId`, `nombre`, `codigoInternoCliente` | `software`, `observaciones` |
| `modulos` | `sistemaRef` (idInterno o nombre), `nombre`, `serie` | `firmware`, `marca`, `observaciones` |

> **`establecimientoRef` y `sistemaRef`:** pueden ser el nombre o el ID interno para facilitar el Excel humano. El script resuelve la referencia durante la fase de parsing.

### 3.2 Script: `scripts/migracion/migrar-desde-excel.ts`

**Estructura del script (ya planificada en docs):**

```
scripts/migracion/
  â”œâ”€ migrar-desde-excel.ts   â† entry point
  â”œâ”€ service-account.json    â† â›” NO commitear (.gitignore)
  â”œâ”€ input/
  â”‚   â”œâ”€ clientes.csv
  â”‚   â”œâ”€ establecimientos.csv
  â”‚   â”œâ”€ sistemas.csv
  â”‚   â””â”€ modulos.csv
  â””â”€ output/                 â† logs de dry-run y run
      â”œâ”€ dry-run-YYYYMMDD.json
      â””â”€ run-report-YYYYMMDD.json
```

**Fases del script:**

```
1. PARSE & VALIDATE
   â”œâ”€ Leer CSV/XLSX con `xlsx` o `csv-parse`
   â”œâ”€ Validar campos obligatorios (throw con fila + columna)
   â”œâ”€ Normalizar CUIT (quitar guiones/espacios)
   â”œâ”€ Detectar duplicados dentro del archivo (mismo CUIT, mismo codigoInterno)
   â””â”€ Emitir warnings (no bloqueantes) vs errors (bloqueantes)

2. CHECK FIRESTORE (deduplicaciÃ³n idempotente)
   â”œâ”€ Para cada cliente: buscar por doc ID (CUIT normalizado)
   â”‚   â””â”€ Si existe: SKIP (log) o UPDATE campos no-destructivos
   â”œâ”€ Para cada sistema: buscar por (establecimientoId + codigoInternoCliente)
   â”‚   â””â”€ Si existe: SKIP
   â””â”€ Para cada mÃ³dulo: buscar en subcolecciÃ³n por (sistemaId + serie)
       â””â”€ Si existe: SKIP

3. BATCH WRITE (Admin SDK)
   â”œâ”€ Orden: clientes â†’ establecimientos â†’ sistemas â†’ modulos
   â”œâ”€ Bloques de max 500 ops por batch()
   â”œâ”€ Rollback: si un batch falla, marcar en log y NO continuar
   â””â”€ Modo --dry-run: loguear todo sin escribir

4. REPORT
   â”œâ”€ Total procesados / creados / skipped / errores
   â””â”€ JSON + console summary
```

**Flags CLI:**
```
npx ts-node migrar-desde-excel.ts --dry-run   # valida y simula
npx ts-node migrar-desde-excel.ts --run       # escribe en Firestore
npx ts-node migrar-desde-excel.ts --run --only=clientes  # solo una entidad
```

**Estrategia de rollback:** No existe rollback automÃ¡tico en Firestore. En cambio:
- `--dry-run` obligatorio antes de `--run`
- El report JSON del `--run` lista todos los IDs creados
- En caso de error: script de "undo" separado que elimina los IDs del report (sÃ³lo si son documentos nuevos, nunca updates)

---

## 4. Nuevo Flujo UX de OT/Reporte (mixto DB + override)

### 4.1 Estados del formulario

```
Estado 1: INICIO
  â”œâ”€ Selector: Cliente (autocomplete sobre /clientes, filtrado por activo:true)
  â””â”€ Al seleccionar: carga establecimientos del cliente

Estado 2: CONTEXTO GEOGRÃFICO
  â”œâ”€ Selector: Establecimiento (filtrado por clienteCuit)
  â”œâ”€ Selector: Contacto (subcolecciÃ³n contactos del establecimiento)
  â””â”€ Al seleccionar: carga sistemas del establecimiento

Estado 3: EQUIPO
  â”œâ”€ Selector: Sistema (filtrado por establecimientoId)
  â”œâ”€ Selector: MÃ³dulo (subcolecciÃ³n del sistema, opcional)
  â””â”€ Al seleccionar sistema: activa Paso 4

Estado 4: TIPO DE SERVICIO
  â”œâ”€ Selector: TipoServicio (catÃ¡logo /tiposServicio)
  â””â”€ Si el tipo requiere protocolo â†’ activa bloque Protocolo

Estado 5 (condicional): PROTOCOLO
  â”œâ”€ Sistema valida sysType del sistema seleccionado
  â”œâ”€ Muestra tablas disponibles para ese sysType/modelo
  â”œâ”€ Pre-selecciona tablas default (isDefault:true)
  â””â”€ TÃ©cnico puede agregar/quitar tablas compatibles (fallback)

Estado 6: DATOS DE TRABAJO
  â”œâ”€ Fechas, horas viajadas, horas trabajadas
  â”œâ”€ ArtÃ­culos/repuestos utilizados
  â”œâ”€ Reporte tÃ©cnico (textarea)
  â””â”€ Acciones futuras (textarea)

Estado 7: PROTOCOLO â€” COMPLETAR TABLAS
  â”œâ”€ Por cada tabla seleccionada: formulario de celdas
  â”œâ”€ ValidaciÃ³n inline por tipo de columna
  â””â”€ Resultado por tabla: CONFORME / NO_CONFORME / PENDIENTE

Estado 8: FIRMAS
  â”œâ”€ Canvas firma tÃ©cnico
  â””â”€ Canvas firma cliente

Estado 9: GUARDAR / GENERAR PDF
  â”œâ”€ Persiste WorkOrder + RenderSpec en Firestore
  â”œâ”€ Genera PDF on-demand (Hoja 1 + Hoja 2 si hay protocolo)
  â””â”€ OpciÃ³n: agregar adjuntos/fotos (subir o capturar)
```

### 4.2 Override manual (campos editables)

Cualquier campo seleccionado desde DB puede ser **editado manual** activando un Ã­cono de lÃ¡piz. El `RenderSpec` guarda tanto `clienteId` (FK) como el snapshot de datos al momento de ediciÃ³n, garantizando reproducibilidad aunque el master cambie.

```
[Campo razonSocial]
  Valor DB: "Laboratorio Pharma S.A."  [âœï¸ editar]
               â†“ si edita
  Campo libre con placeholder "ExcepciÃ³n - ingresÃ© manualmente"
  RenderSpec guardarÃ¡: workOrderSnapshot.razonSocial = "Valor manual"
```

---

## 5. Motor de Protocolos / Tablas

### 5.1 Selector por tipo de sistema / modelo

```typescript
// LÃ³gica de selector (hook useProtocolSelector)
const tablas = await getTablasCatalog({ sysType, modelo });
// Query: /protocolCatalog where sysType == X AND (modelosCompatibles contains modelo OR modelosCompatibles == null)
// Ordenar: isDefault primero, luego por orden asc
```

### 5.2 Compatibilidad y fallback

| Caso | Comportamiento |
|------|----------------|
| Sistema HPLC 1260, modelo conocido | Muestra tablas default para 1260 + tablas genÃ©ricas HPLC |
| Sistema HPLC, modelo desconocido | Muestra tablas genÃ©ricas HPLC (modelosCompatibles: null) |
| Tipo de servicio no requiere protocolo | Oculta secciÃ³n completa |
| TÃ©cnico quiere tabla "no default" | Puede agregarla manualmente desde tablas compatibles |

### 5.3 Conversor Word â†’ Tabla vs. Table Builder

**AnÃ¡lisis:**

| Criterio | Conversor Word (reutilizar) | Table Builder (nuevo) |
|----------|-----------------------------|-----------------------|
| Esfuerzo | Bajo (adaptar lo existente) | Alto (UI compleja) |
| Mantenimiento | Medio (dependencia de formato Word) | Bajo (UI nativa) |
| Flexibilidad | Baja (formatos Word rÃ­gidos) | Alta |
| Acceso del admin | Necesita Word instalado | Cualquier browser |
| Versionado | DifÃ­cil (Word es binario) | FÃ¡cil (Firestore) |
| MigraciÃ³n inicial | Ideal para importar tablas existentes | No aplica |

**RecomendaciÃ³n:**
- **Fase 1:** Usar el conversor Wordâ†’JSON existente **solo para la migraciÃ³n inicial** de tablas ya creadas. Adaptar output al schema `ProtocolTable`.
- **Fase 2:** Construir el **Table Builder** en `sistema-modular` como pantalla de administraciÃ³n. Esto elimina la dependencia de Word y permite que el admin cree/edite tablas desde el browser.
- **Ambos coexisten** durante la transiciÃ³n; el conversor acepta Word y lo importa al mismo Firestore schema.

### 5.4 Encabezado y pie del Protocolo (parametrizable)

```typescript
// En RenderSpec o en ProtocolCatalogEntry
interface ProtocolHeader {
  titulo: string;             // "PROTOCOLO DE CALIFICACIÃ“N OPERACIONAL"
  codigoDocumento: string;    // "PQ-HPLC-001"
  revision: string;           // "Rev. 2.1"
  logoUrl?: string;           // URL en Storage (opcional)
}

interface ProtocolFooter {
  elaboradoPor?: string;
  revisadoPor?: string;
  aprobadoPor?: string;
  vigenciaDesde?: string;
}
```

Estos campos se definen por `ProtocolCatalogEntry` pero pueden ser sobreescritos en `RenderSpec.protocolSelections[].header/footer`.

---

## 6. GeneraciÃ³n PDF (reproducible y determinÃ­stica)

### 6.1 Principios

| Regla | ImplementaciÃ³n |
|-------|----------------|
| Hoja 1 **intocable** | El componente JSX de Hoja 1 no se modifica. Se captura con el mismo selector CSS legacy |
| Hoja 2 **dinÃ¡mica** | Nuevo componente `<ProtocolSheet>` inyectado *debajo* de Hoja 1 en el array de nodos de html2pdf.js â€” SKILL A compliant |
| RegeneraciÃ³n determinÃ­stica | Se usan exactamente los datos del `workOrderSnapshot` + `protocolSelections`. Si el master cambia, el snapshot preserva el estado original |
| Versionado de plantillas | `templateVersion` en `RenderSpec`. Si hay breaking change en Hoja 1: incrementar versiÃ³n â†’ el visor sabe quÃ© renderer usar |
| Adjuntos | Se cargan on-demand. El PDF se genera en 2 modos: "solo reporte+protocolo" y "reporte+protocolo+adjuntos" |

### 6.2 Flujo de regeneraciÃ³n

```
[Usuario pide ver/descargar PDF]
    â”‚
    â–¼
Lee RenderSpec de Firestore
    â”‚
    â”œâ”€â”€ Si hay adjuntosIds y usuario eligiÃ³ "completo":
    â”‚       GET signed URLs de Firebase Storage (expiran en 1h)
    â”‚       Inyectar imÃ¡genes al componente <AnnexSheet>
    â”‚
    â”œâ”€â”€ Renderizar componentes en orden:
    â”‚       <ReporteSheet data={workOrderSnapshot} />   // Hoja 1 â€” intocable
    â”‚       <ProtocolSheet selections={protocolSelections} />  // Hoja 2 â€” dinÃ¡mica
    â”‚       <AnnexSheet fotos={fotosResueltas} />        // Hoja 3 â€” opcional
    â”‚       <AttachmentsSheet archivos={archivosResueltos} />  // Hoja 4 â€” opcional
    â”‚
    â””â”€â”€ html2pdf.capture() â†’ blob â†’ download / preview
```

---

## 7. Persistencia sin PDF

### 7.1 QuÃ© se guarda (y quÃ© NO)

| Dato | Se guarda | Formato |
|------|-----------|---------|
| Datos de la OT | âœ… | `/workorders/{otNumber}` (WorkOrder) |
| Snapshot completo al guardar | âœ… | `RenderSpec.workOrderSnapshot` |
| Selecciones de protocolo + resultados | âœ… | `RenderSpec.protocolSelections[]` |
| Versiones de plantilla/protocolo/renderer | âœ… | `RenderSpec.{templateVersion, protocolVersion, rendererVersion}` |
| Firmas (base64) | âœ… | `WorkOrder.signatureEngineer`, `WorkOrder.signatureClient` |
| Metadatos de adjuntos | âœ… | `/adjuntos/{id}` |
| Binarios de adjuntos/fotos | âœ… | Firebase Storage (no Firestore) |
| PDF binario | âŒ NO | â€” |

### 7.2 Versionado y migraciones futuras

- Cada `RenderSpec` es inmutable una vez finalizado (status FINALIZADO).
- Si se cambia el schema de `ProtocolTable` en el futuro: usar `protocolVersion` para detectar formato antiguo y aplicar migraciÃ³n al leer.
- Estrategia de migraciÃ³n: **lazy migration** (al leer un `RenderSpec` con `protocolVersion < actual`, normalizar on-the-fly y guardar actualizado).

---

## 8. Instrumentos, Certificados y Trazabilidad

> **Agregado:** 2026-02-28 â€” Requisitos levantados de sesiÃ³n de planificaciÃ³n.

### 8.1 Concepto general

Los ingenieros utilizan **instrumentos** (termÃ³metros, manÃ³metros, flujÃ­metros) y **estÃ¡ndares** (muestras de FID, patrones de calibraciÃ³n) para realizar validaciones. Se necesita:

1. Un **catÃ¡logo de instrumentos y estÃ¡ndares** gestionados desde `sistema-modular`.
2. Una **tabla especial `tableType: 'instruments'`** en el catÃ¡logo que, al ser seleccionada, permite elegir instrumentos de una lista y auto-completar NÂ° serie, modelo, etc.
3. Los **certificados de calibraciÃ³n** de cada instrumento/estÃ¡ndar se almacenan en Firestore/Storage y se **anexan automÃ¡ticamente al PDF** final del reporte.
4. Los estÃ¡ndares muestran: cÃ³digo, lote, fecha de vencimiento, y su certificado se anexa al PDF.
5. Cada certificado tiene **fecha de vencimiento**: al vencer, el instrumento es reemplazado por otro vigente, pero el vencido queda vinculado al reporte histÃ³rico (snapshot).

### 8.2 CategorÃ­a de instrumento por tipo de sistema

| Tipo de sistema | Instrumentos disponibles |
|-----------------|--------------------------|
| CromatÃ³grafo LÃ­quido (HPLC) | TermÃ³metro, FlujÃ­metro de lÃ­quidos |
| CromatÃ³grafo Gaseoso (GC) | TermÃ³metro, ManÃ³metro, FlujÃ­metro de gases |

La categorÃ­a filtra quÃ© instrumentos se ofrecen en el selector segÃºn el `sysType` del sistema vinculado a la OT.

### 8.3 Trazabilidad

- Ciertos clientes requieren **documentos de trazabilidad** por cada instrumento: un documento adicional que detalla todos los instrumentos que certificaron el funcionamiento del instrumento de mediciÃ³n.
- La trazabilidad estÃ¡ **directamente ligada al instrumento**: si se selecciona TER-02, a continuaciÃ³n de su certificado aparece su documento de trazabilidad en el PDF.
- Se puede detectar automÃ¡ticamente segÃºn el cliente (pocos clientes la requieren). Se propone un flag `requiereTrazabilidad: boolean` en el documento del cliente en Firestore.
- La trazabilidad se almacena igual que los certificados: en Firestore/Storage, vinculada al instrumento, con vencimiento, y se adjunta al PDF final.

### 8.4 Certificado del IST (Ingeniero de Servicio TÃ©cnico)

- Cada IST tiene su propio certificado profesional, que tambiÃ©n debe anexarse al PDF del reporte.
- Mismo procedimiento que los certificados de instrumentos.
- **Diferencia:** el certificado del IST **no tiene vencimiento**.

### 8.5 Modelo de datos propuesto

```typescript
// â”€â”€â”€ INSTRUMENTOS Y ESTÃNDARES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

type CategoriaInstrumento = 'termometro' | 'manometro' | 'flujimetro_liquidos' | 'flujimetro_gases';

interface InstrumentoPatron {
  id: string;
  tipo: 'instrumento' | 'estandar';
  categoria: CategoriaInstrumento;
  nombre: string;                    // "TermÃ³metro Digital TER-02"
  codigoInterno: string;             // "TER-02"
  marca: string;
  modelo: string;
  numeroDeSerie: string;
  // Para estÃ¡ndares:
  codigoEstandar?: string;           // CÃ³digo del estÃ¡ndar
  lote?: string;
  // Certificados
  certificadoStoragePath: string;    // Ruta en Storage (PDF del certificado)
  certificadoVencimiento: string;    // ISO date â€” fecha de vencimiento
  vigente: boolean;                  // false cuando vence y es reemplazado
  // Trazabilidad (opcional, PDF en Storage)
  trazabilidadStoragePath?: string;  // PDF trazabilidad
  trazabilidadVencimiento?: string;  // ISO date
  // Metadata
  createdAt: string;
  updatedAt: string;
}

// ColecciÃ³n: /instrumentos/{id}
// Almacenamiento certificados: Firebase Storage /certificados/{instrumentoId}/certificado.pdf
// Almacenamiento trazabilidad: Firebase Storage /certificados/{instrumentoId}/trazabilidad.pdf

interface CertificadoIST {
  id: string;
  uid: string;                       // FK a /usuarios
  nombre: string;                    // Nombre del IST
  certificadoStoragePath: string;    // PDF en Storage
  // Sin vencimiento
  createdAt: string;
  updatedAt: string;
}

// ColecciÃ³n: /certificadosIST/{id}
```

### 8.6 Flujo en el PDF

```
[Hoja N â€” Tabla de Instrumentos y EstÃ¡ndares]
  â”œâ”€ Tabla con columnas: Instrumento | CÃ³digo | NÂ° Serie | Modelo | Certificado Nro | Vencimiento
  â””â”€ Para cada instrumento seleccionado:
      â”œâ”€ Hoja N+1: Certificado de calibraciÃ³n (PDF del instrumento)
      â”œâ”€ Hoja N+2: Trazabilidad (si el cliente lo requiere y existe)
      â””â”€ Para estÃ¡ndares: CÃ³digo | Lote | Vencimiento | Certificado

[Ãšltima hoja â€” Certificado IST]
  â””â”€ PDF del certificado del ingeniero que realizÃ³ el servicio
```

### 8.7 RegeneraciÃ³n on-demand

- Como el sistema no almacena PDFs sino que los regenera on-demand, se aplica la misma lÃ³gica que fotos y adjuntos.
- Al regenerar se pregunta: **Â¿Adjuntar certificados?** (SÃ­/No).
- El instrumento vencido queda vinculado al `RenderSpec` (snapshot en `protocolSelections`) â€” si el instrumento fue reemplazado, el reporte histÃ³rico sigue mostrando el vigente al momento del servicio.
- Los certificados actuales (~50 MB total) se almacenan en Firebase Storage (o Google Drive si se prefiere â€” ver D7).

---

## 9. Adjuntos y Fotos

### 9.1 Storage recomendado

**RecomendaciÃ³n: Firebase Storage** (no Drive ni servidor local).

| Criterio | Firebase Storage | Google Drive | Servidor local |
|----------|-----------------|--------------|----------------|
| IntegraciÃ³n nativa con Auth | âœ… | Parcial (OAuth) | âŒ |
| Reglas de seguridad granulares | âœ… | âŒ | Manual |
| Signed URLs | âœ… | Parcial | Manual |
| Sin infraestructura propia | âœ… | âœ… | âŒ |
| Costo | Pay-per-use | Gratis hasta lÃ­mite | Hosting propio |
| Modo offline (tablet) | Con SDK | âŒ | âŒ |

### 9.2 Esquema de seguridad de Storage

```
/adjuntos/{otNumber}/{fileName}
  â†’ Solo lectura: autenticado (tecnico, admin, readonly)
  â†’ Escritura: solo autor de la OT o admin
  â†’ Signed URLs: expiraciÃ³n 1 hora (generadas al visualizar, nunca almacenadas)
```

### 9.3 CÃ³mo se incorporan al PDF

```
[Hoja 3 - Anexo fotogrÃ¡fico]
  Para cada Adjunto de tipo "foto" (ordenado por adjunto.orden):
    â”œâ”€ Imagen a ancho completo (A4 - mÃ¡rgenes)
    â”œâ”€ Caption debajo
    â””â”€ NÃºmero de figura

[Hoja 4 - Archivos adjuntos]
  Para cada Adjunto de tipo "archivo":
    â”œâ”€ Nombre de archivo
    â”œâ”€ Fecha de carga
    â””â”€ Link (no embebido en PDF â€” solo referencia)
```

### 9.4 UI de visualizaciÃ³n (modo demanda)

```
Modal/Screen "Ver OT 30255"
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Â¿QuÃ© desea visualizar/descargar?   â”‚
  â”‚                                     â”‚
  â”‚  â—‰ Solo Reporte + Protocolo         â”‚
  â”‚    (generados, instantÃ¡neo)         â”‚
  â”‚                                     â”‚
  â”‚  â—‹ Reporte completo con adjuntos    â”‚
  â”‚    (carga fotos y archivos, ~Xs)    â”‚
  â”‚                                     â”‚
  â”‚           [Generar PDF]             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Seguridad y Permisos

### 10.1 Roles

| Rol | DescripciÃ³n | Acceso |
|-----|-------------|--------|
| `admin` | Back-office total | Leer/escribir todo. GestiÃ³n de usuarios, catÃ¡logos, clientes |
| `tecnico` | Ingeniero de campo | Crear/editar OTs propias. Leer catÃ¡logos. No gestiona clientes |
| `readonly` | Gerencia / auditores | Solo lectura. No puede crear ni editar |

### 10.2 Reglas Firestore (conceptuales)

```javascript
// /workorders/{otNumber}
allow read: if isAuthenticated();
allow create: if isTecnico() || isAdmin();
allow update: if isAdmin() || (isTecnico() && resource.data.createdBy == request.auth.uid
              && resource.data.status == 'BORRADOR');
allow delete: if isAdmin();

// /protocolCatalog/{catalogId}
allow read: if isAuthenticated();
allow write: if isAdmin();

// /clientes, /establecimientos, /sistemas
allow read: if isAuthenticated();
allow write: if isAdmin();

// /adjuntos/{adjuntoId}
allow read: if isAuthenticated();
allow create: if isTecnico() || isAdmin();
allow delete: if isAdmin();
```

### 10.3 AuditorÃ­a mÃ­nima

Todos los documentos incluyen:
```typescript
{
  createdAt: string;   // ISO
  updatedAt: string;   // ISO
  createdBy: string;   // uid
  // En WorkOrder ademÃ¡s:
  lastEditedBy?: string;
  editHistory?: AuditEntry[]; // Array de { ts, uid, cambios[] } â€” opcional, solo para OTs finalizadas
}
```

---

## 11. Plan por Fases (Roadmap)

### Fase 0 â€” Fundamentos compartidos âœ… PARCIAL
**Objetivo:** Preparar el terreno sin romper nada existente.

| Tarea | Estado | Notas |
|-------|--------|-------|
| Agregar tipos de tablas/protocolo a `@ags/shared` | âœ… Hecho | Tipos reales: `TableCatalogEntry`, `ChecklistItem`, `ChecklistItemAnswer`, `ProtocolSelection` (difieren del plan original pero cubren la funcionalidad) |
| Tipos `RenderSpec`, `Adjunto`, `UsuarioAGS` | âŒ Pendiente | No implementados aÃºn |
| Crear colecciÃ³n `/usuarios` con roles | âŒ Pendiente | |
| CompilaciÃ³n limpia monorepo | âœ… Hecho | `pnpm build` funciona |

**Riesgo:** Bajo.

---

### Fase 1 â€” Import Masivo desde Excel âœ… COMPLETADA
**Objetivo:** Poblar Firestore con Clientes + Establecimientos + Sistemas + MÃ³dulos desde Excel.

| Tarea | Estado |
|-------|--------|
| Script de migraciÃ³n Excel â†’ Firestore | âœ… Implementado |
| ValidaciÃ³n y deduplicaciÃ³n | âœ… |
| Soporte XLSX | âœ… |
| Batch write Admin SDK | âœ… |

**Nota:** Ejecutado con datos reales. Clientes, establecimientos, sistemas y mÃ³dulos cargados.

---

### Fase 2 â€” Nuevo Flujo OT Mixto ğŸ”¶ PARCIAL
**Objetivo:** Reemplazar carga manual de OT por selecciÃ³n desde DB con override.

| Tarea | Estado | Notas |
|-------|--------|-------|
| Selector de cliente desde DB (SearchableSelect â†’ `/clientes`) | âŒ **Pendiente** | Hoy es `<input type="text">` manual. Debe ser dropdown/autocomplete que cargue de Firestore |
| Auto-llenado de establecimiento, contacto, direcciÃ³n | âŒ **Pendiente** | Al seleccionar cliente â†’ listar establecimientos â†’ auto-completar direcciÃ³n, localidad, provincia, contacto |
| Selector de sistema/equipo desde DB | âŒ **Pendiente** | Hoy es texto libre. Debe cargar desde `/sistemas` filtrado por establecimiento |
| Auto-llenado de mÃ³dulo (modelo, serie, descripciÃ³n) | âŒ **Pendiente** | Al seleccionar sistema â†’ cargar mÃ³dulos desde subcolecciÃ³n |
| Persistencia de `WorkOrder` con `protocolSelections` | âœ… | `protocolSelections` se guarda en `/workorders/{otNumber}` |
| Carga/guardado de OT existente | âœ… | `useOTManagement` carga OT por nÃºmero, hidrata el formulario |
| `RenderSpec` como entidad separada | âŒ Pendiente | Los datos se guardan directamente en `WorkOrder`, no hay `RenderSpec` separado aÃºn |
| Modo override con flag "excepciÃ³n" | âŒ Pendiente | Para cuando el tÃ©cnico necesita ingresar datos distintos a los de DB |

**Nota:** El flujo OT funciona end-to-end pero **todos los datos de cliente y equipo se ingresan manualmente como texto libre**. No hay selectores conectados a la base de datos (solo las tablas de protocolo en Fase 3). Esta es la pieza central que falta de Fase 2.

---

### Fase 3 â€” Motor de Protocolos + Tablas ğŸ”¶ EN PROGRESO
**Objetivo:** Selector de tablas dinÃ¡micas y Hoja 2 del PDF.

| Tarea | Estado | Notas |
|-------|--------|-------|
| CatÃ¡logo de tablas (`/tableCatalog`) en sistema-modular | âœ… | CRUD completo, publicaciÃ³n, clonado, importar JSON |
| Table Builder (editor columnas/filas/reglas) | âœ… | `TableEditor.tsx`, `RowFormPanel.tsx` |
| Tipo `checklist` con editor + importador PDF | âœ… | `ChecklistEditor.tsx`, `ImportChecklistPdfDialog.tsx` (con pdfjs-dist) |
| Conversor Wordâ†’ProtocolTable (adaptar existente) | âœ… | `word-to-protocol-json` + `ImportJsonDialog.tsx` |
| TableSelectorPanel en reportes-ot | âœ… | Auto-sugiere tablas segÃºn `tipoServicio`, pre-check |
| CatalogTableView (tÃ©cnico completa filas) | âœ… | Soporta todos los tipos de columna + validaciÃ³n |
| CatalogChecklistView (tÃ©cnico completa checklist) | âœ… | checkbox, value_input, pass_fail, secciones N/A |
| Tablas default por sistema + auto-load | âœ… | `suggestedTables` por `tipoServicio` |
| **Hoja 2 PDF con header/footer por pÃ¡gina** | âŒ **PENDIENTE** | PrÃ³ximo paso â€” headers con logo, OT, cliente; footers con firma, pÃ¡gina X de Y |
| **Encabezado/pie parametrizable** (`ProtocolHeader`/`ProtocolFooter`) | âŒ **PENDIENTE** | Campos en `TableCatalogEntry` o `RenderSpec` |
| Sticky layout en todas las pÃ¡ginas de sistema-modular | âœ… | PatrÃ³n OTList aplicado a 7 pÃ¡ginas |

**Lo que queda de Fase 3:** Formato final del PDF multipÃ¡gina con headers/footers por hoja.

---

### Fase 4 â€” Adjuntos, Fotos y Visor âŒ PENDIENTE
**Objetivo:** Subir fotos/archivos y visualizarlos en el PDF.

| Tarea | Estado | Criterio de aceptaciÃ³n |
|-------|--------|------------------------|
| MÃ³dulo de upload (`useAdjuntos` hook + Firebase Storage) | âŒ Pendiente | Upload de foto/archivo. Metadatos en /adjuntos |
| Captura de foto desde tablet (camera API) | âŒ Pendiente | Foto tomada va directamente a Storage |
| Hojas 3 y 4 del PDF (Anexo + Archivos) | âŒ Pendiente | PDF generado con adjuntos, con signed URLs efÃ­meras |
| Modal de selecciÃ³n de vista (solo reporte vs. completo) | âŒ Pendiente | UX segÃºn mockup en secciÃ³n 9.4 |
| Signed URLs: expiraciÃ³n 1h, nunca guardadas en Firestore | âŒ Pendiente | Verificado: URL expira y no aparece en DB |

**Entregables:** PDF completo con adjuntos opcionales.
**Riesgo:** Medio. Camera API en tablet requiere HTTPS y permisos explÃ­citos.

---

### Fase 5 â€” Instrumentos, Certificados y Trazabilidad âŒ PENDIENTE
**Objetivo:** Gestionar instrumentos y patrones utilizados en servicios, con certificados vinculados y control de vencimiento.

| Tarea | Estado | DescripciÃ³n |
|-------|--------|-------------|
| CatÃ¡logo de instrumentos en sistema-modular | âŒ Pendiente | CRUD de `InstrumentoPatron` en `/instrumentos/{id}`. Campos: nombre, marca, modelo, serie, tipo, categorÃ­a(s), certificado vinculado, vencimiento |
| CategorÃ­a de instrumento por tipo de sistema | âŒ Pendiente | Enum `CategoriaInstrumento` con valores HPLC/GC-especÃ­ficos. Filtro en selector segÃºn `sysType` del equipo |
| GestiÃ³n de certificados con vencimiento | âŒ Pendiente | Upload de certificado PDF a Firebase Storage. Auto-extracciÃ³n de datos (nombre, emisor, vigencia). Alertas de vencimiento prÃ³ximo |
| EstÃ¡ndares (patrones) con cÃ³digo, lote, vencimiento | âŒ Pendiente | Tabla de estÃ¡ndares: cÃ³digo, lote, fecha vencimiento, certificado vinculado. Alertas de vencimiento |
| Flag `requiereTrazabilidad` en clientes | âŒ Pendiente | Checkbox en ficha de cliente. Cuando activo, OT debe incluir hojas de trazabilidad |
| Documentos de trazabilidad | âŒ Pendiente | Trazabilidad vinculada directamente al instrumento. Aparece despuÃ©s del certificado del instrumento en el PDF |
| Certificado del IST (ingeniero) | âŒ Pendiente | PDF del certificado del ingeniero que realizÃ³ el servicio. Sin vencimiento. Se anexa como Ãºltima hoja del reporte |
| Reemplazo de instrumentos (historial) | âŒ Pendiente | Al reemplazar un instrumento vencido, vincular al anterior. Reportes histÃ³ricos mantienen el instrumento vigente al momento del servicio (snapshot) |
| Selector de instrumentos en reportes-ot | âŒ Pendiente | TÃ©cnico selecciona instrumentos usados en la OT. Filtrado por categorÃ­a segÃºn sysType. Snapshot guardado en WorkOrder |
| Anexado de certificados al PDF | âŒ Pendiente | Al generar PDF: opciÃ³n de incluir certificados de instrumentos usados + trazabilidad + certificado IST como hojas adicionales |

**Dependencias:** Fase 4 (sistema de adjuntos/Storage) debe estar funcional antes de certificados.
**Riesgo:** Alto. Requiere definir estructura de Storage para certificados, gestiÃ³n de vencimientos con notificaciones, y lÃ³gica de snapshot para reportes histÃ³ricos.

---

## 12. Checklist de Decisiones Abiertas

| # | DecisiÃ³n | Default recomendado | Impacto si cambia |
|---|----------|---------------------|-------------------|
| D1 | Â¿`renderSpecs` como subcolecciÃ³n de `workorders` o top-level? | **SubcolecciÃ³n** `/workorders/{otNumber}/renderSpec/current` | MÃ­nimo; refactor de queries |
| D2 | Â¿Formato de input para import: Excel con 4 hojas vs 4 CSVs? | **Excel con 4 hojas** (mÃ¡s amigable para el usuario) | Solo el parser |
| D3 | Â¿Table Builder desde Fase 2 o post-conversor Word? | **Post-conversor (Fase 3)**: importar tablas existentes primero, builder como Fase 3b | Esfuerzo del catÃ¡logo |
| D4 | Â¿Guardar firmas en Firestore (base64) o Storage? | **Firestore base64** (ya funciona asÃ­, tamaÃ±o manejable ~20KB) | SKILL A: no tocar |
| D5 | Â¿`editHistory` de auditorÃ­a desde el inicio o post-MVP? | **Post-MVP** (Fase 0 solo `createdBy`/`updatedAt`) | AuditorÃ­a limitada hasta fase posterior |
| D6 | Â¿Adjuntos accesibles offline (PWA cache)?  | **No por ahora** (conexiÃ³n asumida en campo) | Sin complejidad de sync |
| D7 | Â¿Google Drive como fallback de Storage?  | **No** (complejidad OAuth innecesaria) | Si cambia: refactor de todo adjunto |
| D8 | Â¿Signed URLs: duraciÃ³n 1h o 24h? | **1 hora** (seguridad > conveniencia) | Solo config de Storage |
| D9 | Â¿Protocolo obligatorio por tipo de servicio o siempre opcional?  | **Por tipo de servicio**: flag `requiresProtocol` en `/tiposServicio/{id}` | Agregar campo a `TipoServicio` |
| D10 | Â¿Modelos de sistema son catÃ¡logo libre o enum fijo? | **CatÃ¡logo libre** en Firestore (`/categoriaEquipo/{id}/modelos[]`) â€” ya existe `CategoriaEquipo` | Sin impacto (ya diseÃ±ado) |
| D11 | Â¿DÃ³nde se almacenan los certificados de instrumentos? | **Firebase Storage** en `/certificados/{instrumentoId}/{fileName}`. Google Drive descartado por complejidad OAuth | Si cambia: refactor completo de upload/download de certificados |
| D12 | Â¿CÃ³mo se detecta si una OT requiere trazabilidad? | **Flag `requiereTrazabilidad` en cliente**. Si el cliente lo tiene activo, el tÃ©cnico debe incluir hojas de trazabilidad | Agregar campo a `Cliente` y lÃ³gica en reportes-ot |
| D13 | Â¿CategorÃ­as de instrumento por sysType son fijas o configurables? | **Enum fijo** (`CategoriaInstrumento`) con mapeo a sysType. RazÃ³n: las categorÃ­as LC/GC estÃ¡n estandarizadas en la industria | Si cambia: migrar enum a colecciÃ³n Firestore |
| D14 | Â¿El certificado IST tiene vencimiento? | **No**. El certificado del ingeniero se adjunta sin control de vencimiento | Sin impacto |

---

## 13. Quick Wins (1-3 dÃ­as)

- **QW1:** Agregar los nuevos tipos TS (`RenderSpec`, `ProtocolTable`, etc.) a `@ags/shared` y buildear. Cero impacto funcional; habilita todo lo demÃ¡s.
- **QW2:** Crear el skeleton del script `migrar-desde-excel.ts` con `--dry-run` que solo parsea y valida el Excel (sin escribir). Permite al equipo validar el formato del Excel inmediatamente.
- **QW3:** Agregar campo `requiresProtocol: boolean` a la interfaz `TipoServicio` y actualizar en Firestore los tipos existentes. Habilita la lÃ³gica condicional de Fase 3 sin tocar nada de la UI.
- **QW4:** Crear la colecciÃ³n `/usuarios` con documentos para los UIDs existentes y definir roles. Base para seguridad de todas las fases.

---

## 14. High Risk Items

| Ãtem | Riesgo | MitigaciÃ³n |
|------|--------|-----------|
| **R1: SKILL A â€” inyecciÃ³n de Hoja 2** | Alterar el Ã¡rbol JSX puede romper dimensiones de Hoja 1 en html2pdf.js | Inyectar Hoja 2 como nodo separado en el array de captura, nunca dentro del wrapper de Hoja 1. QA con PDF antes y despuÃ©s en tablet real. |
| **R2: Cascada de selectores en OT** | Si los datos en Firestore estÃ¡n incompletos post-import, los selectores quedarÃ¡n vacÃ­os | Validar cobertura de datos con dry-run antes de Fase 2. Mantener siempre override manual. |
| **R3: Import masivo â€” referencias ambiguas** | `establecimientoRef` por nombre puede colisionar si hay dos establecimientos con el mismo nombre en un cliente | Preferir ID interno; documentar regla de unicidad en el Excel template. |
| **R4: Compatibilidad html2pdf.js con tablas dinÃ¡micas** | Las tablas generadas dinÃ¡micamente pueden romperse en saltos de pÃ¡gina | Testear con tablas de 20+ filas en tablet. Implementar page-break CSS antes de asumir que funciona. |
| **R5: Camera API en tablet** | No todos los tablets tienen cÃ¡mara accesible vÃ­a browser sin HTTPS explÃ­cito | Asegurar HTTPS en el entorno tablet desde el inicio. Fallback: solo upload de archivo. |
| **R6: Vencimiento de certificados sin notificaciÃ³n** | Instrumentos con certificado vencido podrÃ­an usarse en OTs sin que el tÃ©cnico lo note | Implementar alertas en sistema-modular (dashboard) y validaciÃ³n al seleccionar instrumento en reportes-ot. Badge visual en instrumentos prÃ³ximos a vencer (30 dÃ­as). |
| **R7: Snapshot de instrumentos en reportes histÃ³ricos** | Al reemplazar un instrumento, los reportes anteriores deben seguir mostrando el instrumento vigente al momento del servicio | Guardar snapshot del instrumento en `WorkOrder.instrumentosUsados[]` al momento de la OT, no referencia viva. Similar al patrÃ³n de `protocolSelections.tableSnapshot`. |

---

## ApÃ©ndice: Diagrama de relaciones de entidades (ER simplificado)

```
Cliente (CUIT)
  â”‚
  â”œâ”€â”€[1:N]â”€â”€ Establecimiento
  â”‚             â”‚
  â”‚             â”œâ”€â”€[1:N]â”€â”€ ContactoEstablecimiento
  â”‚             â””â”€â”€[1:N]â”€â”€ Sistema
  â”‚                          â”‚
  â”‚                          â”œâ”€â”€[1:N]â”€â”€ ModuloSistema
  â”‚                          â””â”€â”€[1:N]â”€â”€ WorkOrder â”€â”€[1:1]â”€â”€ RenderSpec
  â”‚
  â”œâ”€â”€[1:N]â”€â”€ Lead
  â”œâ”€â”€[1:N]â”€â”€ Presupuesto â”€â”€[M:N]â”€â”€ OrdenCompra
  â””â”€â”€ requiereTrazabilidad: boolean

TableCatalogEntry â”€â”€[M:N (via protocolSelections)]â”€â”€ WorkOrder
Adjunto â”€â”€[N:1]â”€â”€ WorkOrder (vÃ­a RenderSpec.adjuntosIds)
UsuarioAGS â”€â”€[1:N]â”€â”€ WorkOrder (createdBy)
  â””â”€â”€ certificadoIST?: string (URL en Storage)

InstrumentoPatron
  â”‚
  â”œâ”€â”€ categorias: CategoriaInstrumento[]
  â”œâ”€â”€ certificadoUrl?: string (Storage)
  â”œâ”€â”€ vencimiento?: Date
  â”œâ”€â”€ reemplazadoPor?: InstrumentoPatron (historial)
  â”œâ”€â”€[1:N]â”€â”€ DocumentoTrazabilidad
  â””â”€â”€[M:N (via WorkOrder.instrumentosUsados)]â”€â”€ WorkOrder
```
